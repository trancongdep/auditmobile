<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>App An To√†n ƒêi·ªán v7 (Final Report)</title>
    <style>
        :root {
            --primary: #0056b3;
            --secondary: #6c757d;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --light: #f8f9fa;
            --dark: #343a40;
            --shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #e9ecef;
            margin: 0;
            padding-bottom: 20px;
        }

        /* --- HEADER --- */
        .app-header {
            background-color: var(--primary);
            color: white;
            padding: 15px;
            text-align: center;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .app-header h1 { margin: 0; font-size: 18px; flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .btn-icon { background: none; border: none; font-size: 20px; cursor: pointer; color: white; padding: 0 10px; }

        .screen { display: none; padding: 15px; animation: fadeIn 0.3s; }
        .screen.active { display: block; }

        /* --- UI COMPONENTS --- */
        .card {
            background: white; padding: 20px; border-radius: 10px;
            box-shadow: var(--shadow); margin-bottom: 20px;
        }
        .big-btn {
            display: flex; align-items: center; justify-content: center; gap: 10px;
            width: 100%; padding: 18px; margin-bottom: 15px;
            border: none; border-radius: 10px;
            font-size: 16px; font-weight: bold; color: white;
            cursor: pointer; box-shadow: var(--shadow);
            text-decoration: none;
        }
        .btn-office { background: linear-gradient(135deg, #0056b3, #004494); }
        .btn-field { background: linear-gradient(135deg, #28a745, #218838); }
        .btn-setting { background: linear-gradient(135deg, #6c757d, #5a6268); }
        
        .btn-action { flex: 1; padding: 12px; border: none; border-radius: 5px; font-weight: bold; color: white; cursor: pointer; }
        .btn-save-manual { background: #007bff; }
        .btn-export { background: #217346; }

        input[type="text"] {
            width: 100%; box-sizing: border-box; padding: 12px; margin: 10px 0;
            border: 1px solid #ccc; border-radius: 5px; font-size: 16px;
        }

        /* --- GRID & LISTS --- */
        .area-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .area-card {
            background: white; padding: 15px; border-radius: 10px;
            text-align: center; box-shadow: var(--shadow); cursor: pointer;
            border: 2px solid transparent;
        }
        .area-card:hover { border-color: var(--primary); }
        .area-icon { font-size: 28px; display: block; margin-bottom: 5px; }

        .unit-item {
            background: white; padding: 15px; margin-bottom: 10px;
            border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex; justify-content: space-between; align-items: center;
        }
        .btn-add { background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 50px; font-weight: bold; margin: 0 auto; display:block; }
        .btn-delete-unit { background: #ffebee; color: var(--danger); border: none; padding: 8px; border-radius: 5px; font-weight:bold; cursor:pointer;}

        /* --- CHECKLIST ITEMS --- */
        .check-card {
            background: white; border-radius: 10px; padding: 15px;
            margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .code-tag { background: #e2e6ea; padding: 2px 6px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        
        .status-row { display: flex; gap: 5px; margin-bottom: 10px; margin-top:10px; }
        .btn-status {
            flex: 1; padding: 10px; border: 1px solid #dee2e6; background: #f8f9fa;
            border-radius: 5px; font-weight: 600; cursor: pointer;
        }
        .btn-status.ok.active { background: var(--success); color: white; border-color: var(--success); }
        .btn-status.ng.active { background: var(--danger); color: white; border-color: var(--danger); }
        .btn-status.na.active { background: var(--secondary); color: white; border-color: var(--secondary); }

        .note-row { display: flex; align-items: center; gap: 8px; }
        textarea.note-input {
            flex: 1; box-sizing: border-box; padding: 10px; 
            border: 1px solid #ced4da; border-radius: 5px; 
            min-height: 45px; font-family: inherit;
        }
        .btn-mic {
            width: 45px; height: 45px; border: none; border-radius: 50%;
            background-color: #e9ecef; color: #333; font-size: 20px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
        }
        .btn-mic.recording { background-color: var(--danger); color: white; animation: pulse 1.5s infinite; }

        /* --- SETTINGS & FOOTER --- */
        .setting-group { margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #eee; }
        .setting-desc { font-size: 14px; color: #666; margin-bottom: 10px; }

        .footer-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: white; padding: 10px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: flex; gap: 10px; z-index: 1000;
        }
        #toast {
            visibility: hidden; min-width: 250px; margin-left: -125px;
            background-color: #333; color: #fff; text-align: center;
            border-radius: 2px; padding: 16px; position: fixed;
            z-index: 2000; left: 50%; bottom: 80px;
        }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 80px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 80px; opacity: 1;} to {bottom: 0; opacity: 0;} }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <div id="toast">Th√¥ng b√°o</div>

    <div class="app-header" id="mainHeader" style="display:none;">
        <button class="btn-icon" onclick="handleBack()">‚¨ÖÔ∏è</button>
        <h1 id="headerTitle">An To√†n ƒêi·ªán</h1>
        <button class="btn-icon" onclick="goHome()">üè†</button>
    </div>

    <div id="screen-welcome" class="screen active">
        <div class="card" style="text-align:center; margin-top:50px;">
            <h2>üë∑‚Äç‚ôÇÔ∏è S·ªï Tay Ki·ªÉm Tra v7</h2>
            <p>H·ªá th·ªëng b√°o c√°o chu·∫©n h√≥a</p>
            <input type="text" id="businessNameInput" placeholder="VD: Nh√† m√°y D·ªát A...">
            <button class="big-btn btn-office" onclick="confirmStartSession()">B·∫Øt ƒë·∫ßu</button>
        </div>
    </div>

    <div id="screen-dashboard" class="screen">
        <div class="card" style="text-align:center;">
            üè¢ ƒê∆°n v·ªã: <strong id="displayBusinessName" style="color:var(--primary)"></strong>
        </div>
        <button class="big-btn btn-office" onclick="goToOfficeCheck()">üìÇ KI·ªÇM TRA H·ªí S∆†</button>
        <button class="big-btn btn-field" onclick="goToFieldSelection()">üèóÔ∏è KI·ªÇM TRA HI·ªÜN TR∆Ø·ªúNG</button>
        <div style="height: 20px;"></div>
        <button class="big-btn btn-setting" onclick="goToSettings()">‚öôÔ∏è C·∫§U H√åNH D·ªÆ LI·ªÜU</button>
    </div>

    <div id="screen-settings" class="screen">
        <div class="card">
            <h3>‚öôÔ∏è Qu·∫£n L√Ω D·ªØ Li·ªáu</h3>
            <div class="setting-group">
                <h4>B∆∞·ªõc 1: T·∫£i file m·∫´u</h4>
                <p class="setting-desc">T·∫£i file c·∫•u tr√∫c c√¢u h·ªèi (.csv) v·ªÅ m√°y.</p>
                <button class="big-btn btn-export" onclick="downloadTemplate()">üì• T·∫£i File M·∫´u</button>
            </div>
            <div class="setting-group">
                <h4>B∆∞·ªõc 2: C·∫≠p nh·∫≠t d·ªØ li·ªáu</h4>
                <p class="setting-desc">T·∫£i file ƒë√£ ch·ªânh s·ª≠a l√™n ·ª©ng d·ª•ng.</p>
                <input type="file" id="checklistImport" accept=".csv" style="display:none" onchange="importChecklist(this)">
                <label for="checklistImport" class="big-btn btn-save-manual" style="cursor:pointer; display:block; text-align:center; padding:12px;">üì§ T·∫£i File L√™n</label>
            </div>
            <div class="setting-group" style="border:none;">
                <button class="big-btn btn-setting" style="background:#dc3545;" onclick="resetDefaultDB()">üîÑ Kh√¥i Ph·ª•c M·∫∑c ƒê·ªãnh</button>
            </div>
        </div>
    </div>

    <div id="screen-field-select" class="screen">
        <h3 style="text-align:center;">Ch·ªçn h·∫°ng m·ª•c</h3>
        <div class="area-grid">
            <div class="area-card" onclick="goToUnitList('SUBSTATION', 'Tr·∫°m Bi·∫øn √Åp')">
                <span class="area-icon">‚ö°</span> <span>Tr·∫°m Bi·∫øn √Åp</span>
            </div>
            <div class="area-card" onclick="goToUnitList('MSB', 'Ph√≤ng MSB')">
                <span class="area-icon">üîå</span> <span>Ph√≤ng ƒêi·ªán Ch√≠nh</span>
            </div>
            <div class="area-card" onclick="goToUnitList('DB', 'T·ªß Ph√¢n Ph·ªëi')">
                <span class="area-icon">üè≠</span> <span>T·ªß Ph√¢n Ph·ªëi</span>
            </div>
            <div class="area-card" onclick="goToUnitList('CABLES', 'C√°p & D√¢y')">
                <span class="area-icon">üöß</span> <span>Tuy·∫øn C√°p</span>
            </div>
            <div class="area-card" onclick="goToUnitList('HAZARD', 'Khu Nguy Hi·ªÉm')">
                <span class="area-icon">üî•</span> <span>Kho H√≥a Ch·∫•t</span>
            </div>
            <div class="area-card" onclick="goToUnitList('WORK', 'Thi C√¥ng')">
                <span class="area-icon">üõ†Ô∏è</span> <span>Gi√°m s√°t Thi c√¥ng</span>
            </div>
        </div>
    </div>

    <div id="screen-unit-list" class="screen">
        <div style="text-align:center; margin-bottom: 20px;">
            <button class="btn-add" onclick="createNewUnit()">+ Th√™m ƒê·ªëi T∆∞·ª£ng M·ªõi</button>
        </div>
        <div id="unit-list-container"></div>
    </div>

    <div id="screen-checklist" class="screen" style="padding-bottom: 80px;">
        <div id="checklist-header-info" style="background:#fff; padding:10px; margin-bottom:15px; font-weight:bold; text-align:center; border-radius:5px;"></div>
        <div id="checklist-container"></div>
        <div class="footer-bar">
            <button class="btn-action btn-save-manual" onclick="manualSave()">üíæ L∆∞u</button>
            <button class="btn-action btn-export" onclick="exportToExcel()">üì• Xu·∫•t B√°o C√°o</button>
        </div>
    </div>

<script>
    // --- 1. DEFAULT DATABASE ---
    const DEFAULT_DB = [
        { id: "DOC-01", area: "OFFICE", text: "Th·ªèa thu·∫≠n ƒë·∫•u n·ªëi & H√†nh lang an to√†n", ref: "Lu·∫≠t ƒêL C2.1" },
        { id: "DOC-02", area: "OFFICE", text: "B√°o c√°o an to√†n ƒëi·ªán ƒë·ªãnh k·ª≥ (tr∆∞·ªõc 10/01)", ref: "Nƒê 62/2025" },
        { id: "DOC-06", area: "OFFICE", text: "Bi√™n b·∫£n ki·ªÉm ƒë·ªãnh thi·∫øt b·ªã >1kV c√≤n h·∫°n", ref: "TT 02/2025" },
        { id: "SUB-01", area: "SUBSTATION", text: "H√†nh lang s·∫°ch s·∫Ω, kh√¥ng v·∫≠t ch√°y/l·∫•n chi·∫øm", ref: "Lu·∫≠t ƒêL ƒê67" },
        { id: "SUB-02", area: "SUBSTATION", text: "Bi·ªÉn b√°o 'C·∫•m l·∫°i g·∫ßn', 'ƒêi·ªán √°p cao' ƒë·∫ßy ƒë·ªß", ref: "Nƒê 62 ƒê18" },
        { id: "PNL-01", area: "MSB", text: "M·∫∑t b·∫±ng tr∆∞·ªõc t·ªß th√¥ng tho√°ng, th·∫£m c√°ch ƒëi·ªán", ref: "C2.3.2" },
        { id: "DB-01", area: "DB", text: "D√¢y d·∫´n ƒëi trong ·ªëng/m√°ng g·ªçn g√†ng", ref: "C2.2.3" },
        { id: "CAB-01", area: "CABLES", text: "M·ªëc b√°o hi·ªáu c√°p ng·∫ßm, ƒë·∫•t kh√¥ng l√∫n", ref: "C2.1.6" },
        { id: "HAZ-01", area: "HAZARD", text: "Thi·∫øt b·ªã ƒëi·ªán ph√≤ng n·ªï (Ex)", ref: "C2.2.4" },
        { id: "JOB-01", area: "WORK", text: "C√≥ Phi·∫øu c√¥ng t√°c / L·ªánh c√¥ng t√°c", ref: "C2.3.6" }
    ];

    // --- 2. GLOBAL VARIABLES ---
    const STORAGE_KEY_APP = 'app_v7_data';
    const STORAGE_KEY_DB = 'app_v7_db_custom';
    
    let checklistDB = [];
    let appState = { businessName: "", officeResults: {}, fieldUnits: [] };
    let currentScreen = 'screen-welcome';
    let currentAreaType = '';
    let currentUnitIndex = -1;

    // --- 3. SPEECH RECOGNITION ---
    let recognition;
    let isRecording = false;
    let currentRecordingId = null;

    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.lang = 'vi-VN';
        recognition.continuous = false; 
        recognition.interimResults = false;

        recognition.onresult = function(event) {
            const transcript = event.results[0][0].transcript;
            if (currentRecordingId) {
                const textarea = document.getElementById('note-' + currentRecordingId);
                if (textarea) {
                    const currentText = textarea.value;
                    const newText = currentText ? currentText + " " + transcript : transcript;
                    textarea.value = newText;
                    setNote(currentRecordingId, newText);
                }
            }
        };
        recognition.onend = function() { stopRecordingUI(); };
    }

    function toggleSpeech(id) {
        if (!recognition) return alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Voice.");
        const btn = document.getElementById('btn-mic-' + id);
        
        if (isRecording && currentRecordingId === id) {
            recognition.stop();
        } else if (isRecording) {
            showToast("ƒêang ghi √¢m m·ª•c kh√°c...");
        } else {
            currentRecordingId = id; isRecording = true;
            btn.classList.add('recording'); recognition.start();
        }
    }
    function stopRecordingUI() {
        if (currentRecordingId) {
            const btn = document.getElementById('btn-mic-' + currentRecordingId);
            if(btn) btn.classList.remove('recording');
        }
        isRecording = false; currentRecordingId = null;
    }

    // --- 4. APP INITIALIZATION ---
    window.onload = function() {
        loadChecklistDB();
        loadAppState();
        if (appState.businessName) showDashboard();
        else switchScreen('screen-welcome');
    };

    function loadChecklistDB() {
        const customDB = localStorage.getItem(STORAGE_KEY_DB);
        checklistDB = customDB ? JSON.parse(customDB) : JSON.parse(JSON.stringify(DEFAULT_DB));
    }
    function loadAppState() {
        const saved = localStorage.getItem(STORAGE_KEY_APP);
        if (saved) {
            try {
                const p = JSON.parse(saved);
                if(!p.fieldUnits) p.fieldUnits = [];
                if(!p.officeResults) p.officeResults = {};
                appState = p;
            } catch(e){}
        }
    }
    function saveState() { localStorage.setItem(STORAGE_KEY_APP, JSON.stringify(appState)); }

    // --- NAVIGATION ---
    function switchScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        currentScreen = id;
        const header = document.getElementById('mainHeader');
        if(id === 'screen-welcome') header.style.display='none';
        else {
            header.style.display='flex';
            const t = document.getElementById('headerTitle');
            if(id==='screen-dashboard') t.innerText="Trang Ch·ªß";
            else if(id==='screen-checklist') t.innerText="Ki·ªÉm Tra";
            else t.innerText="An To√†n ƒêi·ªán";
        }
        window.scrollTo(0,0);
    }
    function handleBack() {
        if(currentScreen==='screen-checklist') currentAreaType==='OFFICE' ? switchScreen('screen-dashboard') : switchScreen('screen-unit-list');
        else if(currentScreen==='screen-unit-list') switchScreen('screen-field-select');
        else if(currentScreen==='screen-field-select' || currentScreen==='screen-settings') switchScreen('screen-dashboard');
    }
    function goHome() { switchScreen('screen-dashboard'); }

    // --- CORE LOGIC ---
    function confirmStartSession() {
        const name = document.getElementById('businessNameInput').value;
        if(!name.trim()) return showToast("Nh·∫≠p t√™n doanh nghi·ªáp!");
        appState.businessName = name;
        saveState(); showDashboard();
    }
    function showDashboard() {
        document.getElementById('displayBusinessName').innerText = appState.businessName;
        switchScreen('screen-dashboard');
    }
    function goToSettings() { switchScreen('screen-settings'); }
    function goToOfficeCheck() {
        currentAreaType = 'OFFICE';
        document.getElementById('checklist-header-info').innerText = "H·ªí S∆† VƒÇN PH√íNG";
        renderChecklist(appState.officeResults, 'OFFICE');
        switchScreen('screen-checklist');
    }
    function goToFieldSelection() { switchScreen('screen-field-select'); }

    // --- UNIT MANAGEMENT ---
    function goToUnitList(area, name) {
        currentAreaType = area; renderUnitList(); switchScreen('screen-unit-list');
    }
    function renderUnitList() {
        const container = document.getElementById('unit-list-container'); container.innerHTML = '';
        const units = appState.fieldUnits.filter(u => u.type === currentAreaType);
        if(units.length === 0) container.innerHTML = `<p style="text-align:center;color:#777">Ch∆∞a c√≥ ƒë·ªëi t∆∞·ª£ng n√†o.<br>B·∫•m n√∫t Th√™m ƒë·ªÉ t·∫°o.</p>`;
        units.forEach(u => {
            const div = document.createElement('div'); div.className = 'unit-item';
            div.innerHTML = `
                <div onclick="openUnit(${u.id})" style="flex-grow:1; cursor:pointer"><strong>${u.name}</strong></div>
                <button class="btn-delete-unit" onclick="deleteUnit(${u.id})">X√≥a</button>
            `;
            container.appendChild(div);
        });
    }
    function createNewUnit() {
        const name = prompt("T√™n ƒë·ªëi t∆∞·ª£ng (VD: T·ªß T·∫ßng 1):");
        if(name) {
            appState.fieldUnits.push({id: Date.now(), type: currentAreaType, name: name, results: {}});
            saveState(); renderUnitList();
        }
    }
    function deleteUnit(id) {
        if(confirm("X√≥a ƒë·ªëi t∆∞·ª£ng n√†y?")) {
            appState.fieldUnits = appState.fieldUnits.filter(u => u.id !== id);
            saveState(); renderUnitList();
        }
    }
    function openUnit(id) {
        const idx = appState.fieldUnits.findIndex(u => u.id === id);
        if(idx < 0) return;
        currentUnitIndex = idx;
        document.getElementById('checklist-header-info').innerText = appState.fieldUnits[idx].name;
        renderChecklist(appState.fieldUnits[idx].results, currentAreaType);
        switchScreen('screen-checklist');
    }

    // --- CHECKLIST RENDERER ---
    function renderChecklist(resultsObj, area) {
        const container = document.getElementById('checklist-container'); container.innerHTML = '';
        const items = checklistDB.filter(i => i.area === area);
        
        if(items.length === 0) { container.innerHTML = `<p style="text-align:center">Ch∆∞a c√≥ c√¢u h·ªèi.</p>`; return; }

        items.forEach(item => {
            const res = resultsObj[item.id] || { status: '', note: '' };
            const div = document.createElement('div'); div.className = 'check-card';
            div.innerHTML = `
                <div><span class="code-tag">${item.id}</span> <small>${item.ref}</small></div>
                <div style="margin:5px 0; font-weight:500;">${item.text}</div>
                <div class="status-row">
                    <button class="btn-status ok ${res.status==='OK'?'active':''}" onclick="setStatus('${item.id}','OK')">ƒê·∫†T</button>
                    <button class="btn-status ng ${res.status==='NG'?'active':''}" onclick="setStatus('${item.id}','NG')">KH√îNG</button>
                    <button class="btn-status na ${res.status==='NA'?'active':''}" onclick="setStatus('${item.id}','NA')">N/A</button>
                </div>
                <div class="note-row">
                    <textarea id="note-${item.id}" class="note-input" placeholder="Ghi ch√∫ (nh·∫≠p ho·∫∑c n√≥i)..." oninput="setNote('${item.id}', this.value)">${res.note}</textarea>
                    <button id="btn-mic-${item.id}" class="btn-mic" onclick="toggleSpeech('${item.id}')">üé§</button>
                </div>
            `;
            container.appendChild(div);
        });
    }

    function setStatus(id, status) {
        let target = (currentAreaType === 'OFFICE') ? appState.officeResults : appState.fieldUnits[currentUnitIndex].results;
        if(!target[id]) target[id] = {note: ''};
        target[id].status = (target[id].status === status) ? '' : status;
        saveState();
        const btns = event.target.parentElement.querySelectorAll('button');
        btns.forEach(b => b.classList.remove('active'));
        if(target[id].status) event.target.classList.add('active');
    }
    
    function setNote(id, val) {
        let target = (currentAreaType === 'OFFICE') ? appState.officeResults : appState.fieldUnits[currentUnitIndex].results;
        if(!target[id]) target[id] = {status: ''};
        target[id].note = val; saveState();
    }

    // --- EXPORT LOGIC (UPDATED V7) ---
    function exportToExcel() {
        const BOM = "\uFEFF";
        let csv = BOM + `DOANH NGHI·ªÜP: ${appState.businessName}\nLo·∫°i,T√™n ƒê·ªëi T∆∞·ª£ng,M√£,N·ªôi Dung,K·∫øt Qu·∫£,Ghi Ch√∫,Tham Chi·∫øu\n`;

        // H√†m chuy·ªÉn ƒë·ªïi status code sang text ti·∫øng Vi·ªát r√µ r√†ng
        const getStatusText = (status) => {
            if (status === 'OK') return 'ƒê·∫°t';
            if (status === 'NG') return 'Kh√¥ng ƒë·∫°t';
            if (status === 'NA') return 'N/A';
            return ''; // Tr·ªëng n·∫øu ch∆∞a ki·ªÉm tra
        };

        const clean = (txt) => (txt || '').replace(/"/g, '""');

        // 1. Office Data
        checklistDB.filter(i => i.area === 'OFFICE').forEach(i => {
            const r = appState.officeResults[i.id] || {status:'',note:''};
            csv += `H·ªì S∆°,VƒÉn Ph√≤ng,${i.id},"${clean(i.text)}",${getStatusText(r.status)},"${clean(r.note)}",${i.ref}\n`;
        });
        
        // 2. Field Data
        appState.fieldUnits.forEach(u => {
            checklistDB.filter(i => i.area === u.type).forEach(i => {
                const r = u.results[i.id] || {status:'',note:''};
                csv += `${u.type},"${clean(u.name)}",${i.id},"${clean(i.text)}",${getStatusText(r.status)},"${clean(r.note)}",${i.ref}\n`;
            });
        });

        // T√™n file theo ƒë·ªãnh d·∫°ng: Baocao_yyyy-MM-dd_HH-mm-ss.csv
        const now = new Date();
        const pad = (n) => n < 10 ? '0'+n : n;
        const filename = `Baocao_${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}_${pad(now.getHours())}-${pad(now.getMinutes())}-${pad(now.getSeconds())}.csv`;

        downloadFile(csv, filename, "text/csv");
    }

    // --- UTILS ---
    function downloadFile(c,n,m) {
        const b = new Blob([c],{type:m});
        const a=document.createElement("a");
        a.href=URL.createObjectURL(b); a.download=n; document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }
    function manualSave() { saveState(); showToast("ƒê√£ l∆∞u!"); }
    function showToast(m) {
        const t = document.getElementById('toast'); t.innerText=m; t.className="show";
        setTimeout(()=>t.className="", 3000);
    }

    // --- SETTINGS LOGIC ---
    function downloadTemplate() {
        const BOM = "\uFEFF"; let csv = BOM + "ID,AreaCode,Content,Reference\n";
        checklistDB.forEach(i => csv += `${i.id},${i.area},"${i.text.replace(/"/g,'""')}","${i.ref.replace(/"/g,'""')}"\n`);
        downloadFile(csv, "Mau_Kiem_Tra.csv", "text/csv");
    }
    function importChecklist(input) {
        const file = input.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const lines = e.target.result.split(/\r\n|\n/); const newDB = [];
            for(let i=1; i<lines.length; i++) {
                // Simple parser
                let parts=[], buf="", inQ=false;
                for(let c of lines[i]) { if(c==='"'){inQ=!inQ;continue} if(c===','&&!inQ){parts.push(buf);buf=""}else buf+=c; }
                parts.push(buf);
                if(parts.length>=3) newDB.push({id:parts[0], area:parts[1], text:parts[2], ref:parts[3]||""});
            }
            if(newDB.length>0) { checklistDB=newDB; localStorage.setItem(STORAGE_KEY_DB, JSON.stringify(checklistDB)); showToast("C·∫≠p nh·∫≠t th√†nh c√¥ng!"); }
        }; reader.readAsText(file);
    }
    function resetDefaultDB() { localStorage.removeItem(STORAGE_KEY_DB); loadChecklistDB(); showToast("ƒê√£ kh√¥i ph·ª•c!"); }
</script>
</body>
</html>
